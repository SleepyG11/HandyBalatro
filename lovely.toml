[manifest]
version = "1.0.0"
dump_lua = true
priority = 0

[[patches]]
[patches.copy]
target = "main.lua"
position = "append"
sources = ["index.lua"]

# Handling key inputs
[[patches]]
[patches.pattern]
target = "engine/controller.lua"
pattern = '''self.held_key_times[key] = 0'''
position = "after"
payload = '''
Handy.move_highlight.use(key)
Handy.insta_cash_out.use(key)
'''
match_indent = true
overwrite = false

# Insta-actions
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''function Card:click()'''
position = "after"
payload = '''
if Handy.insta_actions.use(self) then return end
Handy.last_clicked_card = self
Handy.last_clicked_area = self.area
'''
match_indent = true
overwrite = false

# Dangerous insta-actions and cards highlightning
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''function Card:hover()'''
position = "after"
payload = '''
if Handy.insta_highlight.use(self) then return end
if Handy.dangerous_actions.use(self) then return end
'''
match_indent = true
overwrite = false

# Skipping Cash Out stage
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''local num_dollars = config.dollars or 1'''
position = "after"
payload = '''
Handy.insta_cash_out.dollars = config.dollars or 1
'''
match_indent = true
overwrite = false

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''G.GAME.current_round.dollars = config.dollars'''
position = "before"
payload = '''
Handy.insta_cash_out.is_button_created = true
'''
match_indent = true
overwrite = false

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''G.deck:shuffle('cashout'..G.GAME.round_resets.ante)'''
position = "before"
payload = '''
Handy.insta_cash_out.is_button_created = false
'''
match_indent = true
overwrite = false

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''G.FUNCS.cash_out = function(e)'''
position = "after"
payload = '''
if Handy.insta_cash_out.is_skipped and e.config.button then return end
'''
match_indent = true
overwrite = false

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = '''G.ACC = math.min((G.ACC or 0) + dt*0.2*self.SETTINGS.GAMESPEED, 16)'''
position = "after"
payload = '''
 elseif Handy.insta_cash_out.is_skipped then G.ACC = 999 
'''
match_indent = true
overwrite = false
